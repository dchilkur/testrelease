"use strict";var z=Object.create;var f=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var C=(e,s)=>{for(var t in s)f(e,t,{get:s[t],enumerable:!0})},w=(e,s,t,a)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of S(s))!A.call(e,o)&&o!==t&&f(e,o,{get:()=>s[o],enumerable:!(a=J(s,o))||a.enumerable});return e};var I=(e,s,t)=>(t=e!=null?z(q(e)):{},w(s||!e||!e.__esModule?f(t,"default",{value:e,enumerable:!0}):t,e)),_=e=>w(f({},"__esModule",{value:!0}),e);var p=(e,s,t)=>new Promise((a,o)=>{var r=n=>{try{i(t.next(n))}catch(m){o(m)}},c=n=>{try{i(t.throw(n))}catch(m){o(m)}},i=n=>n.done?a(n.value):Promise.resolve(n.value).then(r,c);i((t=t.apply(e,s)).next())});var H={};C(H,{topo:()=>v,traverseDeps:()=>T,traverseQueue:()=>D});module.exports=_(H);var g=require("path"),k=require("fs"),h=I(require("fast-glob"),1),x=require("toposource"),E=I(require("js-yaml"),1);var P=["dependencies","devDependencies","peerDependencies","optionalDependencies"],Q=e=>p(void 0,null,function*(){let{pkgFilter:s}=e,t=yield $(e),a=yield Promise.all(t.map(o=>p(void 0,null,function*(){let r=(0,g.dirname)(o),c=(0,g.relative)(e.cwd,r),i=yield k.promises.readFile(o,"utf8"),n=JSON.parse(i);return{name:n.name,manifestRaw:i,manifestPath:o,manifest:n,path:c,relPath:c,absPath:r}})));return W(a),a.reduce((o,r)=>(s(r)&&(o[r.name]=r),o),{})}),W=e=>{let s=e.map(t=>t.name).filter((t,a,o)=>o.indexOf(t)!==a);if(s.length>0)throw new Error(`Duplicated pkg names: ${s.join(", ")}`)},G=e=>p(void 0,null,function*(){let s=(0,g.resolve)(e,"package.json"),t=yield k.promises.readFile(s,"utf8"),a=JSON.parse(t);return{name:a.name,manifest:a,manifestPath:s,manifestRaw:t,path:"/",relPath:"/",absPath:(0,g.dirname)(s)}}),v=(...s)=>p(void 0,[...s],function*(e={}){let{cwd:t=process.cwd(),filter:a=u=>!0,pkgFilter:o=a,depFilter:r=u=>!0,workspaces:c,workspacesExtra:i=[]}=e,n=yield G(t),m={cwd:t,filter:a,depFilter:r,pkgFilter:o,workspacesExtra:i,workspaces:[...c||(yield L(n)),...i]},l=yield Q(m),{edges:d,nodes:y}=M(Object.values(l).map(u=>u.manifest),r),{queue:b,graphs:R,next:F,prev:N,sources:j}=(0,x.analyze)([...d,...y.map(u=>[u])]);return{nodes:y,edges:d,queue:b,graphs:R,sources:j,prev:N,next:F,packages:l,root:n}}),L=e=>p(void 0,null,function*(){var s,t;return(Array.isArray(e.manifest.workspaces)?e.manifest.workspaces:(s=e.manifest.workspaces)==null?void 0:s.packages)||((t=e.manifest.bolt)==null?void 0:t.workspaces)||(yield(()=>p(void 0,null,function*(){try{let a=(0,g.resolve)(e.absPath,"pnpm-workspace.yaml");return E.default.load(yield k.promises.readFile(a,"utf8")).packages}catch(a){return null}}))())||[]}),M=(e,s,t=P)=>{let a=e.map(({name:r})=>r).sort();return{edges:e.reduce((r,c)=>{let i=new Set;return O(c,({name:n,version:m,scope:l})=>{!i.has(n)&&a.includes(n)&&s({name:n,version:m,scope:l})&&(i.add(n),r.push([n,c.name]))},t),r},[]).sort(),nodes:a}},$=t=>p(void 0,[t],function*({workspaces:e,cwd:s}){return yield(0,h.default)(e.map(a=>B((0,g.join)(a,"package.json"))),{cwd:s,onlyFiles:!0,absolute:!0})}),B=e=>{let s=/^\\\\\?\\/.test(e),t=/[^\u0000-\u0080]+/.test(e);return s||t?e:e.replace(/\\/g,"/")},D=a=>p(void 0,[a],function*({queue:e,prev:s,cb:t}){let o={};return Promise.all(e.map(r=>o[r]=(()=>p(void 0,null,function*(){yield Promise.all((s.get(r)||[]).map(c=>o[c])),yield t(r)}))()))}),T=o=>p(void 0,[o],function*({packages:e,pkg:s,scopes:t=P,cb:a}){let{manifest:r}=s,c=[];O(r,({name:i,version:n,scope:m,deps:l})=>{let d=e[i];d&&c.push(Promise.resolve(a({name:i,version:n,scope:m,deps:l,pkg:d,parent:s})))},t),yield Promise.all(c)}),O=(e,s,t=P)=>{for(let a of t){let o=e[a];if(o)for(let[r,c]of Object.entries(o))s({name:r,version:c,deps:o,scope:a})}};0&&(module.exports={topo,traverseDeps,traverseQueue});
//# sourceMappingURL=index.cjs.map
